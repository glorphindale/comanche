# comanche

Племени команчей нужен новый вождь.
Условия задания можно прочитать [на сайте Echo|http://www.echorussia.ru/jobs/serverside-june-2013.html]

## Описание

Каждый узел представляет из себя два потока (future). Один поток принимает сообщения, второй
занимается опросом других узлов. Потоки разделют atom с общим состоянием: номер узла-вождя и текущий
статус узла.

Для посылки сообщений используется ZeroMQ, шаблон Request-Reply. Сетевая часть описана в
пространстве имён comanche.smoke

Для упрощения тестирования в каждом процессе может быть запущено несколько узлов кластера.

## Управление

Конфигурационный файл cluster.conf содержит вектор map-ов:
[{:id 0 :location "tcp://127.0.0.1:9000"} ... ]

Для упрощения тестирования программу можно запускать с помощью нескольких опций командной строки:
* lein run -f - запускает в одном процессе сразу все узлы кластера
* lein run 0 2 4 - запускает в одном процессе указанные узлы кластера 
* lein run 1-5 - запускает в одном процессе диапазон узлов (включительно)

Если запустить lein repl, можно отдавать кластеру команды через пространство имён smoke. Помимо
команд протокола, добавлена поддержка двух полезных функций. Например:
* (smoke/send-msg cluster 0 15 "0:EXIT!") для полной остановки узла №15.
* (smoke/send-msg cluster 0 15 "0:REPORT!") для получения текущего состояния узла №15

## Нюансы алгоритма

* Если связь между всеми узлами нарушена - все превратятся в вождей и не починятся, пока какой-то из
  узлов не начнёт выборы.

## TODO
* Полностью отделить алгоритм от сетевой части - автомат, общающийся с сетью через очереди
  сообщений. Проблема - таймауты, решить через core.async?
* Добавить эмуляцию медленных узлов

## License

Copyright © 2013 glorphindale

Distributed under the Eclipse Public License, the same as Clojure.
